<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
</head>
<body>
<div>
    <input type="text" id="msgInp"/>
    <button id="msgBtn">Send</button>
</div>
<hr>
<div id="content"></div>
<script>
    const msgInp = document.querySelector("#msgInp");
    const msgBtn = document.querySelector("#msgBtn")
    const content = document.querySelector("#content");
    msgBtn.addEventListener("click", () => {
        let eventSource = new EventSource(
            `http://localhost:3015/ai/chat/stream?query=${encodeURIComponent(msgInp.value)}`
        );
        eventSource.onopen = () => {
            console.log("onopen 连接成功");
        };
        eventSource.onerror = (e) => {
            console.log("onerror 连接断开", e);
            eventSource.close();
        };
        eventSource.onmessage = (e) => {
            content.innerHTML += e.data;
        };
    })

    const controller = new AbortController();
    const {signal} = controller;
    fetch(`http://localhost:3015/ai/chat/stream?query=${encodeURIComponent(msgInp.value)}`, {
        method: "GET",
        signal
    }).then(async (response) => {
        const reader = response.body.getReader();
        while (true) {
            const {done, value} = await reader.read();
            if (done) break;
            console.log(new TextDecoder().decode(value));
        }
    }).catch((error) => {
        console.error("Fetch error:", error);
    });
</script>
</body>
</html>